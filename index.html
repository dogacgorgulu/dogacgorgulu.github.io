<!-- https://common-verdant-boa.glitch.me --> 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>  
    <title>Modern WebRTC P2P Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 600px;
            margin: 30px auto;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 20px;
        }

        h1 {
            text-align: center;
            font-weight: 400;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 15px;
        }

        .controls > * {
            margin: 5px;
        }

        #peerIdDisplay {
            font-weight: bold;
            color: #333;
        }

        #peerId {
            width: 200px;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #connectionStatus {
            font-weight: bold;
        }

        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: none;
        }

        button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #generateIdButton {
            background: #007BFF;
            color: #fff;
        }

        #connectButton {
            background: #28a745;
            color: #fff;
        }

        #disconnectButton {
            background: #dc3545;
            color: #fff;
        }

        #sendButton {
            background: #007BFF;
            color: #fff;
            margin-top: 5px;
        }

        #chatLog {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: #f9f9f9;
            margin-top: 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        .message {
            display: inline-block;
            clear: both;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 20px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .message.you {
            background: #007BFF;
            color: #fff;
            float: right;
            text-align: right;
        }

        .message.peer {
            background: #e4e6eb;
            color: #333;
            float: left;
        }

        .status {
            text-align: center;
            font-style: italic;
            color: #777;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebRTC P2P Chat</h1>

        <div class="controls">
            <button id="generateIdButton">Generate Peer ID</button>
            <p>Your Peer ID: <span id="peerIdDisplay">Not Generated</span></p>
        </div>

        <div class="controls">
            <label for="peerId">Connect to Peer ID:</label>
            <input type="text" id="peerId" placeholder="Peer ID" />
            <button id="connectButton">Connect</button>
            <button id="disconnectButton" disabled>Disconnect</button>
        </div>

        <h3>Connection Status: <span id="connectionStatus">Not Connected</span></h3>

        <textarea id="messageBox" placeholder="Type a message..." rows="4" disabled></textarea>
        <button id="sendButton" disabled>Send</button>

        <h2>Chat Log</h2>
        <div id="chatLog"></div>
    </div>

    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
    <script>
        // ----- Configuration -----
        const SIGNALING_SERVER_URL = "https://common-verdant-boa.glitch.me"; // Adjust if needed
        const STABLE_ID_KEY = "myStablePeerId";

        // ----- Global Vars -----
        const socket = io(SIGNALING_SERVER_URL, { autoConnect: false });
        let peerConnection;
        let dataChannel;
        let localStableId;
        let targetPeerId;

        // DOM Elements
        const peerIdDisplay = document.getElementById("peerIdDisplay");
        const connectionStatus = document.getElementById("connectionStatus");
        const chatLog = document.getElementById("chatLog");
        const sendButton = document.getElementById("sendButton");
        const disconnectButton = document.getElementById("disconnectButton");
        const messageBox = document.getElementById("messageBox");
        const generateIdButton = document.getElementById("generateIdButton");
        const connectButton = document.getElementById("connectButton");
        const peerIdInput = document.getElementById("peerId");

        // ----- Stable ID Handling -----
        // Check if we have a previously stored stable ID
        localStableId = localStorage.getItem(STABLE_ID_KEY);
        if (!localStableId) {
            // Generate a new stable ID (just a random string)
            localStableId = "user-" + Math.random().toString(36).substr(2, 9);
            localStorage.setItem(STABLE_ID_KEY, localStableId);
        }
        // This stable ID is just for user display and conceptual continuity, 
        // not for maintaining actual WebRTC connections after the browser closes.

        generateIdButton.onclick = () => {
            if (!socket.connected) {
                socket.connect();
            }
            // We display the stable ID as the user's ID for continuity.
            peerIdDisplay.textContent = localStableId;
        };

        socket.on("connect", () => {
            console.log("Socket connected with temporary ID:", socket.id);
            // The "stable" ID is localStableId, shown to the user
            if (!peerIdDisplay.textContent || peerIdDisplay.textContent === "Not Generated") {
                peerIdDisplay.textContent = localStableId;
            }
        });

        connectButton.onclick = async () => {
            targetPeerId = peerIdInput.value.trim();
            if (!targetPeerId) {
                alert("Please enter a valid Peer ID!");
                return;
            }

            connectionStatus.textContent = "Connecting...";
            if (!socket.connected) {
                socket.connect();
            }

            await createPeerConnection();

            dataChannel = peerConnection.createDataChannel("chat");
            setupDataChannel();

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            console.log("Sending offer:", offer);
            socket.emit("signal", { target: targetPeerId, signal: { offer } });
        };

        disconnectButton.onclick = () => {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            // We remain connected to the signaling server so we can do another call if needed.
            connectionStatus.textContent = "Disconnected";
            sendButton.disabled = true;
            disconnectButton.disabled = true;
            messageBox.disabled = true;
            console.log("Disconnected from Peer");
        };

        async function createPeerConnection() {
            peerConnection = new RTCPeerConnection({
                iceServers: [
                    { urls: "stun:stun.l.google.com:19302" },
                    {
                        urls: "turn:relay.metered.ca:80",
                        username: "user",
                        credential: "pass"
                    }
                ]
            });

            peerConnection.onicecandidate = (event) => {
                if (event.candidate && targetPeerId) {
                    console.log("Sending ICE candidate:", event.candidate);
                    socket.emit("signal", { target: targetPeerId, signal: { candidate: event.candidate } });
                }
            };

            peerConnection.onconnectionstatechange = () => {
                console.log("Connection state:", peerConnection.connectionState);
                if (peerConnection.connectionState === "connected") {
                    connectionStatus.textContent = "Connected";
                    disconnectButton.disabled = false;
                } else if (peerConnection.connectionState === "disconnected" || peerConnection.connectionState === "failed") {
                    connectionStatus.textContent = "Disconnected";
                }
            };

            peerConnection.ondatachannel = (event) => {
                console.log("DataChannel received:", event.channel);
                dataChannel = event.channel;
                setupDataChannel();
            };
        }

        function setupDataChannel() {
            dataChannel.onopen = () => {
                console.log("DataChannel is open!");
                messageBox.disabled = false;
                sendButton.disabled = false;
            };

            dataChannel.onclose = () => {
                console.log("DataChannel is closed.");
                messageBox.disabled = true;
                sendButton.disabled = true;
            };

            dataChannel.onmessage = (event) => {
                const message = event.data;
                console.log("Message received:", message);
                addMessageToLog(message, false);
            };
        }

        sendButton.onclick = () => {
            const message = messageBox.value.trim();
            if (message && dataChannel && dataChannel.readyState === "open") {
                dataChannel.send(message);
                console.log("Sent message:", message);
                addMessageToLog(message, true);
                messageBox.value = "";
            } else {
                console.error("DataChannel is not open or invalid message.");
            }
        };

        function addMessageToLog(message, isYou) {
            const msgDiv = document.createElement("div");
            msgDiv.classList.add("message");
            msgDiv.classList.add(isYou ? "you" : "peer");
            msgDiv.textContent = message;
            chatLog.appendChild(msgDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        socket.on("signal", async ({ signal, sender }) => {
            console.log("Received signal:", signal, "from:", sender);

            if (signal.offer) {
                console.log("Received offer, creating answer...");
                await createPeerConnection();
                await peerConnection.setRemoteDescription(signal.offer);
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                console.log("Sending answer:", answer);
                socket.emit("signal", { target: sender, signal: { answer } });
                targetPeerId = sender;
            } else if (signal.answer) {
                console.log("Received answer, setting remote description...");
                await peerConnection.setRemoteDescription(signal.answer);
            } else if (signal.candidate) {
                console.log("Received ICE candidate, adding...");
                await peerConnection.addIceCandidate(signal.candidate).catch(e => console.error(e));
            }
        });
    </script>
</body>
</html>
