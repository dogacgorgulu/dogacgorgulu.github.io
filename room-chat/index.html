<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password-Protected Chat Room</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>Password-Protected Chat Room</h1>
    </header>

    <div class="room-controls">
        <input type="text" id="roomId" placeholder="Enter Room ID" />
        <input type="password" id="roomPassword" placeholder="Enter Password" />
        <button id="createRoomButton">Create Room</button>
        <button id="joinRoomButton">Join Room</button>
    </div>

    <div id="chatArea" class="hidden">
        <div id="chatLog"></div>
        <div class="composer">
            <textarea id="messageBox" placeholder="Type a message..." disabled></textarea>
            <button id="sendButton" disabled>Send</button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
    <script>
        const socket = io("https://common-verdant-boa.glitch.me/room-chat"); // Replace with your Glitch server URL
        const chatLog = document.getElementById("chatLog");
        const messageBox = document.getElementById("messageBox");
        const sendButton = document.getElementById("sendButton");
        const roomIdInput = document.getElementById("roomId");
        const roomPasswordInput = document.getElementById("roomPassword");
        const createRoomButton = document.getElementById("createRoomButton");
        const joinRoomButton = document.getElementById("joinRoomButton");
        const chatArea = document.getElementById("chatArea");

        let roomId = null;
        let peerConnection;
        let dataChannel;

        createRoomButton.onclick = () => {
            const roomId = roomIdInput.value.trim();
            const password = roomPasswordInput.value.trim();

            if (!roomId || !password) {
                alert("Please enter a room ID and password!");
                return;
            }

            socket.emit("create-room", { roomId, password }, (response) => {
                alert(response.message);
            });
        };

        joinRoomButton.onclick = () => {
            roomId = roomIdInput.value.trim();
            const password = roomPasswordInput.value.trim();

            if (!roomId || !password) {
                alert("Please enter a room ID and password!");
                return;
            }

            socket.emit("join-room", { roomId, password }, (response) => {
                if (response.success) {
                    alert(response.message);
                    chatArea.classList.remove("hidden");
                    setupWebRTC();
                } else {
                    alert(response.message);
                }
            });
        };

        function setupWebRTC() {
            socket.on("user-joined", ({ userId }) => {
                console.log(`User ${userId} joined`);
                createOffer(userId);
            });

            socket.on("signal", async ({ sender, signal }) => {
                console.log(`Signal received from ${sender}`);
                if (signal.offer) {
                    await peerConnection.setRemoteDescription(signal.offer);
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    socket.emit("signal", { roomId, target: sender, signal: { answer } });
                } else if (signal.answer) {
                    await peerConnection.setRemoteDescription(signal.answer);
                } else if (signal.candidate) {
                    await peerConnection.addIceCandidate(signal.candidate);
                }
            });

            peerConnection = new RTCPeerConnection({
                iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
            });

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit("signal", { roomId, target: roomId, signal: { candidate: event.candidate } });
                }
            };

            peerConnection.ondatachannel = (event) => {
                dataChannel = event.channel;
                setupDataChannel();
            };

            dataChannel = peerConnection.createDataChannel("chat");
            setupDataChannel();
        }

        function createOffer(target) {
            peerConnection.createOffer().then((offer) => {
                peerConnection.setLocalDescription(offer);
                socket.emit("signal", { roomId, target, signal: { offer } });
            });
        }

        function setupDataChannel() {
            dataChannel.onopen = () => {
                sendButton.disabled = false;
                messageBox.disabled = false;
            };

            dataChannel.onmessage = (event) => {
                appendMessage(event.data, "peer");
            };
        }

        sendButton.onclick = () => {
            const message = messageBox.value.trim();
            if (message && dataChannel.readyState === "open") {
                dataChannel.send(message);
                appendMessage(message, "you");
                messageBox.value = "";
            }
        };

        function appendMessage(text, sender) {
            const msgDiv = document.createElement("div");
            msgDiv.className = `message ${sender}`;
            msgDiv.textContent = text;
            chatLog.appendChild(msgDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        }
    </script>
</body>
</html>

