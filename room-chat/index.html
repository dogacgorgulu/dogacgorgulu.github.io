<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password-Protected Chat Room</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>Password-Protected Chat Room</h1>
    </header>

    <div class="room-controls">
        <input type="text" id="roomId" placeholder="Enter Room ID" />
        <input type="password" id="roomPassword" placeholder="Enter Password" />
        <button id="createRoomButton">Create Room</button>
        <button id="joinRoomButton">Join Room</button>
    </div>

    <div id="chatArea" class="hidden">
        <div id="chatLog"></div>
        <div class="composer">
            <textarea id="messageBox" placeholder="Type a message..." disabled></textarea>
            <button id="sendButton" disabled>Send</button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
    <script>
        const socket = io("https://common-verdant-boa.glitch.me/room-chat"); // Replace with your Glitch server URL
        const chatLog = document.getElementById("chatLog");
        const messageBox = document.getElementById("messageBox");
        const sendButton = document.getElementById("sendButton");
        const roomIdInput = document.getElementById("roomId");
        const roomPasswordInput = document.getElementById("roomPassword");
        const createRoomButton = document.getElementById("createRoomButton");
        const joinRoomButton = document.getElementById("joinRoomButton");
        const chatArea = document.getElementById("chatArea");

        let roomId = null;
        let peerConnections = {}; // Keep track of peer connections
        let dataChannels = {}; // Store data channels for each peer

        createRoomButton.onclick = () => {
            const roomId = roomIdInput.value.trim();
            const password = roomPasswordInput.value.trim();

            if (!roomId || !password) {
                alert("Please enter a room ID and password!");
                return;
            }

            socket.emit("create-room", { roomId, password }, (response) => {
                alert(response.message);
            });
        };

        joinRoomButton.onclick = () => {
            roomId = roomIdInput.value.trim();
            const password = roomPasswordInput.value.trim();

            if (!roomId || !password) {
                alert("Please enter a room ID and password!");
                return;
            }

            socket.emit("join-room", { roomId, password }, (response) => {
                if (response.success) {
                    alert(response.message);
                    chatArea.classList.remove("hidden");
                    setupSignaling();
                } else {
                    alert(response.message);
                }
            });
        };

        function setupSignaling() {
            socket.on("user-joined", ({ userId }) => {
                console.log(`User ${userId} joined`);
                createPeerConnection(userId);
                createDataChannel(userId);
            });

            socket.on("signal", async ({ sender, signal }) => {
                const pc = peerConnections[sender];
                if (!pc) {
                    createPeerConnection(sender);
                }

                if (signal.offer) {
                    await pc.setRemoteDescription(signal.offer);
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    socket.emit("signal", { roomId, target: sender, signal: { answer } });
                } else if (signal.answer) {
                    await pc.setRemoteDescription(signal.answer);
                } else if (signal.candidate) {
                    await pc.addIceCandidate(signal.candidate);
                }
            });
        }

        function createPeerConnection(target) {
            const pc = new RTCPeerConnection({
                iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
            });

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit("signal", { roomId, target, signal: { candidate: event.candidate } });
                }
            };

            pc.ondatachannel = (event) => {
                const channel = event.channel;
                setupDataChannel(channel, target);
            };

            peerConnections[target] = pc;
        }

        function createDataChannel(target) {
            const pc = peerConnections[target];
            const channel = pc.createDataChannel("chat");
            setupDataChannel(channel, target);
        }

        function setupDataChannel(channel, target) {
            dataChannels[target] = channel;

            channel.onopen = () => {
                console.log(`Data channel open with ${target}`);
                messageBox.disabled = false;
                sendButton.disabled = false;
            };

            channel.onmessage = (event) => {
                appendMessage(event.data, "peer");
            };
        }

        sendButton.onclick = () => {
            const message = messageBox.value.trim();
            if (!message) return;

            for (const target in dataChannels) {
                if (dataChannels[target].readyState === "open") {
                    dataChannels[target].send(message);
                }
            }

            appendMessage(message, "you");
            messageBox.value = "";
        };

        function appendMessage(text, sender) {
            const msgDiv = document.createElement("div");
            msgDiv.className = `message ${sender}`;
            msgDiv.textContent = text;
            chatLog.appendChild(msgDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        }
    </script>
</body>
</html>

