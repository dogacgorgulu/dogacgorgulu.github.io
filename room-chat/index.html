<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Chat Room</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Welcome Screen -->
    <div id="controls">
        <h1>Welcome to the Chat Room</h1>
        <input id="displayNameInput" type="text" placeholder="Enter your display name" />
        <button id="joinButton">Join Chat</button>
    </div>

    <!-- Chat Screen 
    <div id="chatScreen" class="hidden">
        Header
        <header>
            <h1>Chat Room</h1>
        </header>

        Chat Log
        <div id="chatLog"></div>

       Message Composer 
        <div id="chatBox">
            <input id="chatInput" type="text" placeholder="Type a message..." />
            <button id="sendButton">Send</button>
        </div>
    </div>
-->
    <div class="chatScreen">
        <header>
            <h1>Chat Room</h1>
        </header>
        <div id="chatLog"></div>

        <div class="chatBox">
            <textarea id="chatInput" type="text" placeholder="Type a message..."></textarea>
            <button id="sendButton">Send</button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
    <script>
        // Load audio files
        const messageSound = new Audio("./sounds/message.mp3");
        const notificationSound = new Audio("./sounds/notification.mp3");

        const socket = io("https://common-verdant-boa.glitch.me/broadcast"); // Connect to the /chat namespace

        const welcomeScreen = document.getElementById("welcomeScreen");
        const chatScreen = document.getElementById("chatScreen");
        const displayNameInput = document.getElementById("displayNameInput");
        const joinButton = document.getElementById("joinButton");
        const chatLog = document.getElementById("chatLog");
        const chatInput = document.getElementById("chatInput");
        const sendButton = document.getElementById("sendButton");

        let displayName = "";

        // Listen for Enter key to send message
        chatInput.addEventListener("keypress", (event) => {
            if (event.key === "Enter") {
                event.preventDefault(); // Prevent newline
                sendMessage();
            }
        });

        // Handle button click to send message
        sendButton.onclick = () => sendMessage();

        function sendMessage() {
            const message = chatInput.value.trim();
            if (message) {
                socket.emit("message", { text: message }); // Send message to server
                appendMessage({ name: "You", text: message }, "you"); // Append locally
                chatInput.value = ""; // Clear input
                chatInput.focus(); // Keep focus for quick typing
            }
        }

        // Join the chatroom
        joinButton.onclick = () => {
            const name = displayNameInput.value.trim();
            if (!name) {
                alert("Please enter a display name!");
                return;
            }
            displayName = name;
            socket.emit("join", displayName); // Notify server of the new user
            welcomeScreen.classList.add("hidden");
            chatScreen.classList.remove("hidden");
        };

        // Handle name changes
        displayNameInput.onchange = () => {
            const newName = displayNameInput.value.trim();
            if (newName && newName !== displayName) {
                socket.emit("changeName", newName);
                displayName = newName;
            }
        };

        // Handle message sending
        sendButton.onclick = () => {
            const message = chatInput.value.trim();
            if (message) {
                socket.emit("message", { text: message }); // Send only the text
                appendMessage({ name: "You", text: message }, "you"); // Local append
                chatInput.value = "";
                chatInput.focus(); // Keep keyboard open
            }
        };


        function appendMessage({ name, text }, sender) {
            const messageDiv = document.createElement("div");
            messageDiv.className = `message ${sender}`;
            messageDiv.innerHTML = `<strong>${name}:</strong> ${text}`;
            
            // Append the new message to the chat log
            chatLog.appendChild(messageDiv);

            // Auto-scroll to the bottom
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // Listen for incoming messages
        socket.on("message", (data) => {
            if (data.name !== displayName) {
                appendMessage(data, "peer");
                messageSound.play();
            }
        });

        // Display system messages (e.g., join/leave notifications)
        socket.on("system", (message) => {
            const messageDiv = document.createElement("div");
            messageDiv.className = "system-message";
            messageDiv.textContent = message;
            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
            notificationSound.play();
        });

    </script>
</body>
</html>
